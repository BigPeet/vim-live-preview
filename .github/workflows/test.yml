---
name: Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  vader:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        vim-tag: ["v9.1.0"]
    steps:
        - uses: actions/checkout@v2
          with:
            fetch-depth: 0
        - name: Clone Vim
          run: |
            git clone https://github.com/vim/vim.git
        - name: Checkout and Build Vim ${{ matrix.vim-tag }}
          run: |
            cd vim/
            git checkout ${{ matrix.vim-tag }}
            cd src/
            ./configure \
              --disable-gpm \
              --disable-nls \
              --disable-sysmouse \
              --enable-gui=no \
              --enable-multibyte \
              --enable-python3interp \
              --with-features=huge \
              --with-tlib=ncurses \
              --without-x
            make -j$(nproc)
            sudo make install
            vim --version
        - name: Clone Vader.vim
          run: |
            git clone https://github.com/junegunn/vader.vim.git
        - name: Run Vader Tests
          run: |
            echo "rtp+=$(pwd)" > $HOME/.vimrc
            echo "rtp+=$(pwd)/vader.vim" >> $HOME/.vimrc
            echo "Vim config:"
            cat $HOME/.vimrc
            echo "Starting tests:"
            ./test/run_vader_tests.sh -v
